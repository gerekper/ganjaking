var updraft_restore_screen=!0;jQuery(function(p){var o,n,d,l=p("#updraftplus_ajax_restore_job_id").val(),e=p("#updraftplus_ajax_restore_action").val(),u=0,i=p("#updraftplus_ajax_restore_output"),_=p(".updraft_restore_components_list"),r=!1,f=0,g=0;function c(e,t){var r=new XMLHttpRequest,t="action="+t+"&updraftplus_ajax_restore=do_ajax_restore&job_id="+e,o=0,n=!0,d=p("#updraftplus_ajax_restore_debug").length;r.open("POST",ajaxurl,!0),r.onprogress=function(e){if(200<=e.currentTarget.status&&e.currentTarget.status<300){if(-1!==e.currentTarget.responseText.indexOf("<html"))return n&&(n=!1,alert("UpdraftPlus "+updraftlion.ajax_restore_error+" "+updraftlion.ajax_restore_invalid_response)),i.append("UpdraftPlus "+updraftlion.ajax_restore_error+" "+updraftlion.ajax_restore_invalid_response),console.log("UpdraftPlus restore error: HTML detected in response could be a copy of the WordPress front page caused by mod_security"),void console.log(e.currentTarget.responseText);if(o!=e.currentTarget.responseText.length){u=Math.round(Date.now()/1e3);for(var t,r=e.currentTarget.responseText.substr(o),a=(o=e.currentTarget.responseText.length,0),s=0;a<r.length;)"RINFO:{"==r.substr(a,7)?(i.append(r.substring(s,a).trim()).scrollTop(i[0].scrollHeight),t=ud_parse_json(r.substr(a),!0),1==d&&console.log(t),h(t.parsed),a=s=a+t.json_last_pos-t.json_start_pos+6):a++;i.append(r.substr(s).trim()).scrollTop(i[0].scrollHeight),i.find("input[name=connection_type]").length&&i.find("#upgrade").length&&(p(".updraft_restore_main").addClass("show-credentials-form"),p("#message").length&&(p(".restore-credential-errors .restore-credential-errors--list").appendTo(p("#message")),p(".restore-credential-errors .restore-credential-errors--link").appendTo(p("#message"))))}}else 0==e.currentTarget.status?i.append("UpdraftPlus "+updraftlion.ajax_restore_error+" "+updraftlion.ajax_restore_contact_failed):i.append("UpdraftPlus "+updraftlion.ajax_restore_error+" "+e.currentTarget.status+" "+e.currentTarget.statusText),console.log("UpdraftPlus restore error: "+e.currentTarget.status+" "+e.currentTarget.statusText),console.log(e.currentTarget)},r.onload=function(){var e,t=i.find(".updraft_restore_successful, .updraft_restore_error");t.length&&((e=p(".updraft_restore_result")).slideDown(),_.slideUp(),_.siblings("h2").slideUp(),t.is(".updraft_restore_successful")?(e.find(".dashicons").addClass("dashicons-yes"),e.find(".updraft_restore_result--text").text(t.text()),e.addClass("restore-success")):t.is(".updraft_restore_error")&&(e.find(".dashicons").addClass("dashicons-no-alt"),e.find(".updraft_restore_result--text").text(t.text()),e.addClass("restore-error")),setTimeout(function(){i.scrollTop(i[0].scrollHeight)},500))},r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.send(t)}function h(e){var t,r,a,s;"started"==e.stage&&(o=setInterval(function(){var e;(e=Math.round(Date.now()/1e3)-u)<60?p("#updraftplus_ajax_restore_last_activity").html(updraftlion.last_activity.replace("%d",e)):0<(e=120-e)?p("#updraftplus_ajax_restore_last_activity").html(updraftlion.no_recent_activity.replace("%d",e)):(p("#updraftplus_ajax_restore_last_activity").html(""),updraft_send_command("get_restore_resume_notice",{job_id:l},function(e){e.hasOwnProperty("status")&&"success"==e.status&&e.hasOwnProperty("html")?(o&&clearInterval(o),"plugins"!=d&&"db"!=d&&f<5?(f++,c(l,"updraft_ajaxrestore_continue")):p(".updraft_restore_main--components").prepend(e.html)):e.hasOwnProperty("error_code")&&e.hasOwnProperty("error_message")&&(o&&clearInterval(o),alert(e.error_code+": "+e.error_message),console.log(e.error_code+": "+e.error_message))},{error_callback:function(e,t,r,a){500==e.status&&g<3?(g++,c(l,"updraft_ajaxrestore_continue")):(h({stage:"finished",type:"state_change"}),t="updraft_send_command: error: "+t+" ("+r+")",alert(t),console.log(t),console.log(e))}}))},5e3)),"finished"==e.stage&&o&&(clearInterval(o),p("#updraftplus_ajax_restore_last_activity").html("")),e&&("state"!=e.type&&"state_change"!=e.type||(console.log(e.stage,e.data),d="files"==e.stage?e.data.entity:e.stage,t=_.find("[data-component="+d+"]"),"files"==e.stage&&t.find(".updraft_component--progress").html(" — "+updraftlion.restore_files_progress.replace("%s1","<strong>"+e.data.fileindex+"</strong>").replace("%s2","<strong>"+e.data.total_files+"</strong>")),"db"==e.stage&&e.data.hasOwnProperty("stage")&&("table"==e.data.stage?t.find(".updraft_component--progress").html(" — "+updraftlion.restore_db_table_progress.replace("%s","<strong>"+e.data.table+"</strong>")):"stored_routine"==e.data.stage?t.find(".updraft_component--progress").html(" — "+updraftlion.restore_db_stored_routine_progress.replace("%s","<strong>"+e.data.routine_name+"</strong>")):"finished"==e.data.stage?t.find(".updraft_component--progress").html(" — "+updraftlion.finished):"begun"==e.data.stage&&t.find(".updraft_component--progress").html(" — "+updraftlion.begun+"...")),n!==d&&(n&&((a=_.find("[data-component="+n+"]")).find(".updraft_component--progress").html(""),a.removeClass("active").addClass("done")),"finished"==d?(t.addClass("done"),_.find("[data-component]").each(function(e,t){($el=p(t)).is(".done")||$el.addClass("error")}),e.data.hasOwnProperty("actions")&&"object"==typeof e.data.actions&&(a=e.data.urls,s=[],p.each(a,function(e,t){var r=new XMLHttpRequest;r.open("GET",t,!1),r.send(null),404==r.status&&s.push(t)}),r=s,p.isEmptyObject(r)||(p(".updraft_restore_result").before(updraftlion.ajax_restore_404_detected),p.each(r,function(e,t){p(".updraft_missing_pages").append("<li>"+t+"</li>")})),p.each(e.data.actions,function(e,t){_.after('<a href="'+t+'" class="button button-primary">'+e+"</a>")}))):t.addClass("active")),n=d))}p("#updraft-restore-hidethis").remove(),c(l,e),p("#updraftplus_ajax_restore_progress").on("click","#updraft_restore_resume",function(e){e.preventDefault(),p("#updraftplus_ajax_restore_progress").slideUp(1e3,function(){p(this).remove()}),c(l,"updraft_ajaxrestore_continue")}),p(document).on("heartbeat-tick",function(e,t){t.hasOwnProperty("wp-auth-check")&&(t["wp-auth-check"]?(r&&t["wp-auth-check"]&&(u=Math.round(Date.now()/1e3),r=!1),!t.hasOwnProperty("updraftplus")||(t=t.updraftplus).hasOwnProperty("updraft_credentialtest_nonce")&&(updraft_credentialtest_nonce=t.updraft_credentialtest_nonce,u=Math.round(Date.now()/1e3))):r=!0)})});