!function(e,i){"use strict";var d;e&&e.customize&&((d=e.customize).SPHeader=d.SPHeader||{},d.SPHeader.WidgetsCollection=Backbone.Collection.extend(),d.SPHeader.Widgets=new d.SPHeader.WidgetsCollection,d.SPHeader.WidgetModel=Backbone.Model.extend({defaults:{id:null,x:null,y:null,w:null,h:null},initialize:function(){this.on("change",this.updateSetting)},removeFromSetting:function(){var e=d.SPHeader.Setting.getValue();e=_.omit(e,this.get("id")),d.SPHeader.Setting.setValue(e,!0)},updateSetting:function(){var e=d.SPHeader.Setting.getValue();e[this.get("id")]={x:this.get("x"),y:this.get("y"),w:this.get("w"),h:this.get("h")},d.SPHeader.Setting.setValue(e,!0)}}),d.SPHeader.WidgetView=e.Backbone.View.extend({events:{"click .sp-header-widget-delete":"removeWidget"},parent:null,title:"",initialize:function(){this.parent=this.options.parent,this.title=this.options.title,this.render()},render:function(){return this.$el.attr("data-gs-min-width",2),this.$el.attr("data-widget-id",this.model.get("id")),this.$el.append(i("<div/>").addClass("grid-stack-item-content").append(i("<h3/>").text(this.title)).append(i("<span/>").addClass("sp-header-widget-delete"))),this},removeWidget:function(){var e=this.model.get("id");this.model.removeFromSetting(),this.model.collection.remove(this.model),this.parent.grid.removeWidget(this.$el),this.parent.shelf.find('[data-component-id="'+e+'"]').show()}}),d.SPHeader.HeaderCustomizerView=e.Backbone.View.extend({el:"#sp-header-configurator",events:{"click .sp-header-components-shelf a":"addWidgetFromShelf"},grid:null,shelf:null,initialize:function(){try{this.initGridstack()}catch(e){}},didInitialize:function(){return!_.isNull(this.grid)},initGridstack:function(){this.grid=this.$el.find(".sp-header-gridstack").gridstack({itemClass:"grid-stack-item",width:12,height:10,cellHeight:40,cell_width:40,acceptWidgets:".grid-stack-item",float:!0,resizable:{handles:"e, w"}}).data("gridstack"),this.$el.find(".sp-header-gridstack").bind("change",_.bind(this.updateWidgets,this)),this.shelf=this.$el.find(".sp-header-components-shelf")},open:function(){i("body").addClass("sp-header-panel-visible")},close:function(){i("body").removeClass("sp-header-panel-visible")},updateWidgets:function(){this.maybeToggleEmptyClass(),_.each(this._getGridData(),this.updateSingleWidget,this)},updateSingleWidget:function(e){var t=d.SPHeader.Widgets.get(e.id);parseInt(t.get("x"),10)!==parseInt(e.x,10)&&t.set("x",parseInt(e.x,10)),parseInt(t.get("y"),10)!==parseInt(e.y,10)&&t.set("y",parseInt(e.y,10)),parseInt(t.get("w"),10)!==parseInt(e.w,10)&&t.set("w",parseInt(e.w,10)),parseInt(t.get("h"),10)!==parseInt(e.h,10)&&t.set("h",parseInt(e.h,10))},maybeToggleEmptyClass:function(){var e=!0,t=this._getGridData();t&&0<t.length&&(e=!1),this.$el.find(".sp-header-gridstack-wrapper").toggleClass("sp-header-grid-empty",e)},_getGridData:function(){var t;return _.map(this.$el.find(".sp-header-gridstack").find(".grid-stack-item:visible"),function(e){return e=i(e),t=e.data("_gridstack_node"),{id:_.escape(e.attr("data-widget-id")),x:parseInt(t.x,10),y:parseInt(t.y,10),w:parseInt(t.width,10),h:parseInt(t.height,10)}})},addWidgetFromShelf:function(e){this.addWidget(i(e.target).attr("data-component-id"),!1)},addWidget:function(e,t){e&&(t=t||new d.SPHeader.WidgetModel({id:e}),d.SPHeader.Widgets.add(t),e=new d.SPHeader.WidgetView({id:"sp-header-widget-"+t.get("id"),className:"grid-stack-widget",model:t,parent:this,title:this.shelf.find('[data-component-id="'+t.get("id")+'"]').text()}),t.get("x")||t.get("y")||t.get("w")||t.get("h")?this.grid.addWidget(e.$el,t.get("x"),t.get("y"),t.get("w"),t.get("h")):this.grid.addWidget(e.$el,0,0,2,1,!0),this.shelf.find('[data-component-id="'+t.get("id")+'"]').hide())}}),d.SPHeader.Setting={setting:null,$settingField:null,init:function(){var e=d.state("saved").get();this.setting=d("sp_header_setting"),_.isEmpty(this.setting.get())?this.setValue({},!1):this.setValue(this.setting.get(),!1),this.setting._dirty=!1,d.state("saved").set(e),this.$settingField=i('[data-customize-setting-link="sp_header_setting"]')},getValue:function(){return JSON.parse(decodeURI(this.setting.get()))},setValue:function(e,t){this.setting.set(encodeURI(JSON.stringify(e))),t&&this.$settingField.trigger("change")}},d.bind("ready",function(){d.SPHeader.HeaderCustomizer=new d.SPHeader.HeaderCustomizerView,d.SPHeader.HeaderCustomizer.didInitialize()&&(d.SPHeader.Setting.init(),_.each(d.SPHeader.Setting.getValue(),function(e,t){e=new d.SPHeader.WidgetModel({id:_.escape(t),x:parseInt(e.x,10),y:parseInt(e.y,10),w:parseInt(e.w,10),h:parseInt(e.h,10)});d.SPHeader.HeaderCustomizer.addWidget(t,e)}),i(".sp-header-open").on("click",function(e){e.preventDefault(),i(this).hasClass("sp-header-active")?(d.SPHeader.HeaderCustomizer.close(),i(this).removeClass("sp-header-active")):(d.SPHeader.HeaderCustomizer.open(),i(this).addClass("sp-header-active"))}),i(".customize-section-back").on("click",function(){d.SPHeader.HeaderCustomizer.close(),i(".sp-header-open").removeClass("sp-header-active")}))}))}(window.wp,jQuery);