jQuery(function(d){"use strict";d.fn.serializeObject=function(){var t={},e=this.serializeArray();return d.each(e,function(){t[this.name]?(t[this.name].push||(t[this.name]=[t[this.name]]),t[this.name].push(this.value||"")):t[this.name]=this.value||""}),t},d.WC_OD_Calendar=function(t,e){this.options=d.extend(!0,{},{language:"en",weekStart:0,eventsType:"",loadingText:"",modalContent:"No content",eventTooltipContent:"",modalTexts:{add:"Add event",edit:"Edit event","delete":"Are you sure you want to delete this event?",saving:"",deleting:""},ajaxActions:{fetch:"wc_od_calendar_fetch_events",add:"wc_od_calendar_add_event",update:"wc_od_calendar_update_event","delete":"wc_od_calendar_delete_event"}},t),this.$calendar=d(e),this.$modal=d(this.options.modalContent),this.$modalForm=this.$modal.find("form").prepend('<input type="hidden" name="type" value="'+this.options.eventsType+'" />'),this.modalAction="add",this.currentEvent=null},d.WC_OD_Calendar.prototype={_init:function(){var e,r=this;this._bindEvents(),this.$calendar.fullCalendar({header:{left:"prev,next today",center:"title",right:""},allDayDefault:!0,events:function(t,e,n,o){var i=r.$calendar.find(".fc-view-container");i.block(r.getBlockUIOptions(r.options.loadingText,"#fff")),d.ajax({url:ajaxurl,type:"POST",dataType:"json",data:{action:r.options.ajaxActions.fetch,filters:{timezone:n,start:t.format(),end:e.format(),type:r.options.eventsType}},success:function(t){var e,n=[];for(e in t){var a=r.getEventObject(t[e]);n.push(a)}i.unblock(),o(n)},error:function(){i.find(".blockMsg").text("there was an error while fetching events!")}})},selectable:!0,firstDay:r.options.weekStart,select:function(t,e){e={start:t,end:e};r.setModalAction("add"),r.loadEventForm(e),r.$modal.dialog("open")},eventClick:function(t){r.currentEvent=t,r.setModalAction("edit"),r.loadEventForm(t),r.$modal.dialog("open")},eventRender:function(t,e){t=r.getTooltipContent(t);e.tooltipster({contentAsHTML:!0,content:t,minWidth:250})}}),d.ui&&d.ui.dialog&&d.ui.dialog.prototype._allowInteraction&&(e=d.ui.dialog.prototype._allowInteraction,d.ui.dialog.prototype._allowInteraction=function(t){return d(t.target).closest(".select2-dropdown").length||e(t)}),this.$modal.dialog({dialogClass:"wp-dialog wc-od-dialog",title:this.options.modalTexts.add,modal:!0,autoOpen:!1,closeOnEscape:!0,minWidth:450,create:function(){var n=r.$modalForm.find('input[name="start"]'),a=r.$modalForm.find('input[name="end"]');r.$modalForm.find(".date-field").wc_od_datepicker({autoclose:!0,format:"yyyy-mm-dd",language:r.options.language,weekStart:r.options.weekStart}).on("changeDate",function(){var t=d(this).attr("name"),e=d(this).val();"start"===t?a.wc_od_datepicker("option","startDate",!!e&&new Date(e)):"end"===t&&n.wc_od_datepicker("option","endDate",!!e&&new Date(e))}),r.$modalForm.find(".actions .cancel").on("click",function(t){return t.preventDefault(),r.$modal.dialog("close"),!1}),r.$modalForm.find(".actions .delete").on("click",function(t){return t.preventDefault(),window.confirm(r.options.modalTexts["delete"])&&r.currentEvent&&r.eventAction("delete",r.getEventData(r.currentEvent)),!1})}})},_bindEvents:function(){var e=this;this.$modalForm.on("submit",function(t){return t.preventDefault(),t=d(this).serializeObject(),e.eventAction(e.modalAction,t),!1}),d(this).on("eventAdded eventUpdated eventDeleted",function(){e.$modal.dialog("close"),e.$modalForm[0].reset(),e.$modalForm.unblock()})},eventAction:function(t,e){this.$modalForm.block(this.getBlockUIOptions("delete"===t?this.options.modalTexts.deleting:this.options.modalTexts.saving,this.$modalForm.closest(".ui-dialog").css("backgroundColor"))),this[t+"Event"](e)},addEvent:function(t){var n=this;this.syncEvent("add",t,function(t){var e=n.getEventObject(t);n.$calendar.fullCalendar("renderEvent",e,!1),d(n).trigger("eventAdded",t)})},editEvent:function(t){var e,n=this,a=this.getEventObject(t);for(e in a)a.hasOwnProperty(e)&&(this.currentEvent[e]=a[e]);t=this.getEventData(this.currentEvent),this.syncEvent("update",t,function(){n.$calendar.fullCalendar("updateEvent",n.currentEvent),n.currentEvent=null,d(n).trigger("eventUpdated",t)})},deleteEvent:function(t){var e=this;this.syncEvent("delete",t,function(){e.$calendar.fullCalendar("removeEvents",t.id),e.currentEvent=null,d(e).trigger("eventDeleted",t)})},syncEvent:function(t,e,n){d.ajax({url:ajaxurl,type:"POST",dataType:"json",data:{action:this.options.ajaxActions[t],event:e},success:function(t){"success"===t.status?"function"==typeof n&&n(t.event):"error"===t.status&&window.alert(t.message)}})},getEventData:function(t){var e=this.$calendar.fullCalendar("getCalendar"),n={id:t._id,type:this.options.eventsType,title:t.title||"",start:e.moment(t.start).format()};return n.end=t.end?e.moment(t.end).subtract(1,"days").format():n.start,n},getEventObject:function(t){var e=t,n=this.$calendar.fullCalendar("getCalendar");return e.start=n.moment(t.start),t.end&&(e.end=n.moment(t.end).add(1,"days")),e},loadEventForm:function(t){var e=this.getEventData(t),n=this.$modalForm.find('input[name="start"]'),t=this.$modalForm.find('input[name="end"]');t.wc_od_datepicker("option","startDate",!!e.start&&new Date(e.start)),n.wc_od_datepicker("option","endDate",!!e.end&&new Date(e.end)),n.wc_od_datepicker("update",e.start),t.wc_od_datepicker("update",e.end),this.$modalForm.find('input[name="title"]').val(e.title)},setModalAction:function(t){var e=this.$modal.find(".actions .delete");this.modalAction=t,this.$modal.dialog("option","title",this.options.modalTexts[t]),"edit"===t?e.show():e.hide()},getTooltipContent:function(t){var e,n,a,o=this.getEventData(t),i=this.options.eventTooltipContent,r=i.match(/{{.+}}/g);for(a in r)e=r[a].replace("{{","").replace("}}",""),n=o.hasOwnProperty(e)&&null!==o[e]&&undefined!==o[e]?o[e]:"-",i=i.replace("{{"+e+"}}",n);return i},getBlockUIOptions:function(t,e){return{message:t,css:{fontSize:"18px",color:"inherit",backgroundColor:"transparent",border:"none"},overlayCSS:{backgroundColor:e,opacity:.7,cursor:"wait"}}}},d.WC_OD_Delivery_Calendar=function(){d.WC_OD_Calendar.apply(this,arguments),this.options=d.extend({},{countryStates:[]},this.options),this.options.countryStates=JSON.parse(this.options.countryStates)},d.WC_OD_Delivery_Calendar.prototype=d.extend({},d.WC_OD_Calendar.prototype,{_bindEvents:function(){var n=this;d.WC_OD_Calendar.prototype._bindEvents.apply(this,arguments),this.$modal.on("dialogcreate",function(){var t=n.$modalForm.find('[name="country"]'),e=n.$modalForm.find('[name="states"]');t.select2({width:"100%",allowClear:!0}).on("change",function(){e.empty().val("").trigger("change"),n._initStatesSelect2(t,e)})})},_initStatesSelect2:function(t,e){t=this.options.countryStates[t.val()];e.select2({width:"100%",allowClear:!0,multiple:!0,data:t=t||[]})},loadEventForm:function(t){var e=this.getEventData(t),n=this.$modalForm.find('[name="country"]'),t=this.$modalForm.find('[name="states"]');d.WC_OD_Calendar.prototype.loadEventForm.apply(this,arguments),n.val(e.country).trigger("change"),t.val(e.states).trigger("change"),this._initStatesSelect2(n,t)},getEventData:function(t){var e=d.WC_OD_Calendar.prototype.getEventData.apply(this,arguments);return e.country=t.country||"",e.states=t.states||"",e},getEventObject:function(t){var e=d.WC_OD_Calendar.prototype.getEventObject.apply(this,arguments);return t.states||(e.states=""),e}}),d.fn.WC_OD_Calendar=function(t){return this.each(function(){new d.WC_OD_Calendar(t,this)._init()}),this},d.fn.WC_OD_Delivery_Calendar=function(t){return this.each(function(){new d.WC_OD_Delivery_Calendar(t,this)._init()}),this}});